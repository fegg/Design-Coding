<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="../node_modules/jquery/dist/jquery.min.js"></script>
</head>

<body>
  <div id="content"></div>
  <script>
    /**
     * node v16, 浏览器环境可能 resolve 输出有差异
     * async function 有一定差异 https://juejin.cn/post/6844903740667854861#heading-4
     */
    // 1, 3, 5, script start, async2 start, async2 doing
    // promise constructor, script end, 4, async2 end, promise then, 2, run timeout
    function test1() {
      console.log(1);
      setTimeout(function () {
        console.log(2);
      }, 0);
      new Promise(resolve => {
        console.log(3);
        resolve();
      }).then(() => {
        console.log(4);
      });
      console.log(5);

      console.log('script start');

      async function async1() {
        console.log('async2 start');
        await async2();
        console.log('async2 end');
      }

      async function async2() {
        console.log('async2 doing');
      }

      setTimeout(() => {
        console.log('run timeout');
      }, 0);

      async1();

      new Promise((resolve) => {
        console.log('promise constructor');

        resolve();
      }).then(() => {
        console.log('promise then');
      });

      console.log('script end');
    }

    /**
     * 主要是微任务 nextTick 以及 Promise 默认是微任务执行上下文
     */
    // 1, 7, 6
    // 8, 2, 4, 3, 5
    // 9, 11, 10, 12
    function test2() {
      console.log('1')
      setTimeout(function () {
        console.log('2')
        process.nextTick(function () {
          console.log('3')
        })
        new Promise(function (resolve) {
          console.log('4')
          resolve()
        }).then(function () {
          console.log('5')
        })
      })

      process.nextTick(function () {
        console.log('6')
      })

      new Promise(function (resolve) {
        console.log('7')
        resolve()
      }).then(function () {
        console.log('8')
      })

      setTimeout(function () {
        console.log('9')
        process.nextTick(function () {
          console.log('10')
        })
        new Promise(function (resolve) {
          console.log('11')
          resolve()
        }).then(function () {
          console.log('12')
        })
      })
    }

    // 主要是遇到宏任务 jump
    // 1~12 依次输出
    function test3() {
      new Promise(function (resolve) {
        console.log('1')// 宏任务一
        resolve()
      }).then(function () {
        console.log('3') // 宏任务一的微任务
      })
      setTimeout(function () { // 宏任务二
        console.log('4')
        setTimeout(function () { // 宏任务五
          console.log('7')
          new Promise(function (resolve) {
            console.log('8')
            resolve()
          }).then(function () {
            console.log('10')
            setTimeout(function () {  // 宏任务七
              console.log('12')
            })
          })
          console.log('9')
        })
      })
      setTimeout(function () { // 宏任务三
        console.log('5')
      })
      setTimeout(function () {  // 宏任务四
        console.log('6')
        setTimeout(function () { // 宏任务六
          console.log('11')
        })
      })
      console.log('2') // 宏任务一
    }

    function test4() {
      setTimeout(function () {
        console.log('6');
      }, 0);

      console.log('1');

      /**
       * async1 like to promise sugar
       * 
       * return new Promise(() => {
       *  console.log(2);
       * 
       *  return new Promise((resolve) => {
       *    // async2
       *    console.log(3);
       *  }).then(() => {
       *    console.log(5);
       *  });
       * });
       */
      async function async1() {
        console.log('2');
        await async2();
        console.log('5'); // 属于 async 包裹的微任务 callback
      }

      async function async2() {
        console.log('3');
      }

      async1();
      console.log('4');
    }

    function testRaf() {
      new Promise((resolve) => {
        resolve();
      }).then(() => {
        $('#content').append('p1');
      });
      new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, 0);
      }).then(() => {
        $('#content').append('p2');
      });
      window.requestAnimationFrame(() => {
        $('#content').append('raf');
      });
      new Promise((resolve) => {
        resolve();
      }).then(() => {
        $('#content').append('p3');
      });
    }
    testRaf();
  </script>
</body>

</html>